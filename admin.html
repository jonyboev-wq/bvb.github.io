<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin — BVB</title>
<link rel="icon" href="logo.png">
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body{min-height:100vh;padding-bottom:40px}
  .pad{padding:20px}
  .editor-grid{display:flex;flex-direction:column;gap:20px;margin-top:16px}
  .edit-card{border:1px solid var(--border);border-radius:16px;padding:16px;background:var(--card);box-shadow:var(--shadow)}
  .edit-head{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:14px}
  .edit-head strong{font-size:18px}
  .edit-head .muted{font-size:13px}
  .form-grid{display:grid;gap:12px}
  .two-cols{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
  label{font-size:13px;color:var(--muted);display:grid;gap:6px}
  input,textarea,select{
    width:100%;border:1px solid var(--border);border-radius:12px;background:transparent;
    padding:10px 12px;color:var(--text);font:inherit
  }
  textarea{min-height:100px;resize:vertical}
  .tall{min-height:160px}
  .muted{color:var(--muted)}
  .checkbox{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted)}
  .checkbox input{width:auto}
  .list-empty{padding:16px;border:1px dashed var(--border);border-radius:12px;text-align:center;color:var(--muted)}
  .product-preview{margin-top:16px;border:1px dashed var(--border);border-radius:14px;padding:12px}
  .product-preview .card{box-shadow:none;border-radius:12px}
  .product-preview h4{margin:0 0 6px;font-size:16px}
  .card-mini{display:flex;flex-direction:column;gap:10px}
  .card-mini img{width:100%;border-radius:12px;height:180px;object-fit:cover;border:1px solid var(--border)}
  .btn.danger{border-color:#d64545;color:#d64545}
  .btn.danger:hover{background:#d64545;color:#fff}
  .btn.ghost{border-style:dashed}
  .section-head{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .small-note{font-size:13px;color:var(--muted)}
  .json-area{min-height:220px}
</style>
</head>
<body>
<main class="container">
  <div class="card pad">
    <h2 style="margin-top:0">Редактор карточек</h2>
    <p class="muted" style="margin-bottom:16px">Введите пароль, чтобы загрузить текущий <b>shopConfig.json</b> и редактировать товары и соцсети прямо в браузере.</p>
    <div id="login" style="display:flex;gap:10px;flex-wrap:wrap">
      <input id="pass" type="password" placeholder="Пароль (popkop06)">
      <button class="btn primary" onclick="auth()">Войти</button>
    </div>
  </div>

  <div id="panel" class="editor-grid" style="display:none">
    <div class="edit-card">
      <div class="section-head">
        <div>
          <h3 style="margin:0">Соцсети</h3>
          <div class="small-note">Используйте для кнопок Avito, Telegram, WhatsApp и т.д.</div>
        </div>
        <button class="btn small" id="addSocial">+ Добавить соцсеть</button>
      </div>
      <div id="socialList" class="form-grid"></div>
    </div>

    <div class="edit-card">
      <div class="section-head">
        <div>
          <h3 style="margin:0">Товары</h3>
          <div class="small-note">Заполните данные — слева формы, справа превью карточки.</div>
        </div>
        <button class="btn small" id="addProduct">+ Добавить товар</button>
      </div>
      <div id="productsList" class="form-grid"></div>
    </div>

    <div class="edit-card">
      <div class="section-head">
        <div>
          <h3 style="margin:0">Экспорт JSON</h3>
          <div class="small-note">После редактирования скачайте файл и замените им <b>shopConfig.json</b> в репозитории.</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" onclick="download()">Скачать JSON</button>
          <button class="btn" onclick="load()">Подтянуть с сайта</button>
          <label class="btn ghost" style="cursor:pointer">
            Импорт JSON<input id="file" type="file" accept="application/json" style="display:none" onchange="imp()">
          </label>
        </div>
      </div>
      <textarea id="json" class="json-area" spellcheck="false"></textarea>
    </div>
  </div>
</main>

<datalist id="icon-options">
  <option value="avito">
  <option value="tg">
  <option value="wa">
  <option value="telegram">
  <option value="whatsapp">
</datalist>

<script>
const PASSWORD = 'popkop06';
const state = { socials: [], products: [] };
const $ = (s) => document.querySelector(s);
const panel = $('#panel');
const socialList = $('#socialList');
const productsList = $('#productsList');
const jsonArea = $('#json');
const addSocialBtn = $('#addSocial');
const addProductBtn = $('#addProduct');

function auth(){
  if($('#pass').value.trim() === PASSWORD){
    $('#login').style.display = 'none';
    panel.style.display = 'flex';
    load();
  }else{
    alert('Неверный пароль');
  }
}

function normalizeSocial(s={}){
  return {
    label: s.label || '',
    url: s.url || '',
    icon: s.icon || ''
  };
}

function normalizeProduct(p={}){
  const summary = p.short || p.desc || '';
  return {
    title: p.title || '',
    slug: p.slug || '',
    price: valueToString(p.price),
    oldPrice: valueToString(p.oldPrice),
    currency: p.currency || '₽',
    tag: p.tag || '',
    category: p.category || '',
    stock: p.stock || '',
    available: p.available !== false,
    summary,
    description: p.description || '',
    avitoUrl: p.avitoUrl || '',
    images: Array.isArray(p.images) ? p.images.slice() : []
  };
}

function valueToString(v){
  if(v === null || v === undefined) return '';
  return String(v);
}

function setState(data){
  state.socials = Array.isArray(data.socials) ? data.socials.map(normalizeSocial) : [];
  state.products = Array.isArray(data.products) ? data.products.map(normalizeProduct) : [];
  renderSocials();
  renderProducts();
  syncJSON();
}

async function load(){
  try{
    const r = await fetch('shopConfig.json', {cache:'no-cache'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();
    setState(data);
  }catch(e){
    alert('Не удалось загрузить shopConfig.json. Проверьте, что файл лежит рядом с admin.html.');
    setState({socials:[], products:[]});
  }
}

function download(){
  syncJSON();
  const blob = new Blob([jsonArea.value], {type:'application/json'});
  const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'shopConfig.json'});
  a.click();
  URL.revokeObjectURL(a.href);
}

function imp(){
  const file = $('#file').files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);
      setState(data);
    }catch(err){
      alert('Не получилось разобрать JSON: '+err.message);
    }
  };
  reader.readAsText(file);
}

function slugify(str){
  return (str||'').toString().trim().toLowerCase()
    .replace(/[^a-z0-9а-яё\-\s]/gi,'').replace(/\s+/g,'-');
}

function escapeHTML(str=''){
  return str.replace(/[&<>"']/g, ch => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[ch]));
}

function renderSocials(){
  if(!state.socials.length){
    socialList.innerHTML = '<div class="list-empty">Нет соцсетей. Нажмите «Добавить».</div>';
    return;
  }
  socialList.innerHTML = state.socials.map((s,i)=>`
    <div class="edit-card" style="padding:14px;border:none;box-shadow:none;border-radius:12px;background:transparent">
      <div class="edit-head" style="margin-bottom:8px">
        <strong>Соцсеть ${i+1}</strong>
        <button class="btn small danger" data-remove-social="${i}">Удалить</button>
      </div>
      <div class="form-grid two-cols">
        <label>Название
          <input data-soc-field="label" data-index="${i}" value="${escapeHTML(s.label)}">
        </label>
        <label>Ссылка
          <input type="url" data-soc-field="url" data-index="${i}" value="${escapeHTML(s.url)}">
        </label>
        <label>Иконка (avito, tg, wa…)
          <input list="icon-options" data-soc-field="icon" data-index="${i}" value="${escapeHTML(s.icon)}">
        </label>
      </div>
    </div>
  `).join('');
}

function renderProducts(){
  if(!state.products.length){
    productsList.innerHTML = '<div class="list-empty">Пока нет товаров. Добавьте первую карточку.</div>';
    return;
  }
  productsList.innerHTML = state.products.map((p,i)=>productTemplate(p,i)).join('');
}

function productTemplate(p,i){
  const slug = p.slug || slugify(p.title);
  const preview = productPreview(p);
  const images = (p.images||[]).join('\n');
  return `
    <div class="edit-card" data-product="${i}" style="padding:18px">
      <div class="edit-head">
        <div>
          <strong>${escapeHTML(p.title||'Без названия')}</strong>
          <div class="muted" data-slug-label="${i}">slug: ${escapeHTML(slug)}</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn small" data-duplicate-product="${i}">Дублировать</button>
          <button class="btn small danger" data-remove-product="${i}">Удалить</button>
        </div>
      </div>
      <div class="form-grid two-cols">
        <label>Название
          <input data-product-field="title" data-index="${i}" value="${escapeHTML(p.title)}">
        </label>
        <label>Slug (если оставить пустым, создастся автоматически)
          <input data-product-field="slug" data-index="${i}" value="${escapeHTML(p.slug)}">
        </label>
        <label>Цена
          <input data-product-field="price" data-index="${i}" value="${escapeHTML(p.price)}" inputmode="decimal">
        </label>
        <label>Старая цена
          <input data-product-field="oldPrice" data-index="${i}" value="${escapeHTML(p.oldPrice)}" inputmode="decimal">
        </label>
        <label>Валюта
          <input data-product-field="currency" data-index="${i}" value="${escapeHTML(p.currency)}">
        </label>
        <label>Тег/бейдж
          <input data-product-field="tag" data-index="${i}" value="${escapeHTML(p.tag)}">
        </label>
        <label>Категория
          <input data-product-field="category" data-index="${i}" value="${escapeHTML(p.category)}">
        </label>
        <label>Статус склада
          <input data-product-field="stock" data-index="${i}" value="${escapeHTML(p.stock)}">
        </label>
        <label>Ссылка на Avito
          <input data-product-field="avitoUrl" data-index="${i}" value="${escapeHTML(p.avitoUrl)}">
        </label>
        <label class="checkbox">
          <input type="checkbox" data-product-field="available" data-index="${i}" ${p.available ? 'checked' : ''}>
          В наличии / показывать на сайте
        </label>
      </div>
      <label>Краткое описание (каталог)
        <textarea data-product-field="summary" data-index="${i}">${escapeHTML(p.summary)}</textarea>
      </label>
      <label>Описание на странице товара
        <textarea class="tall" data-product-field="description" data-index="${i}">${escapeHTML(p.description)}</textarea>
      </label>
      <label>Ссылки на изображения (каждое с новой строки)
        <textarea class="tall" data-product-field="images" data-index="${i}">${escapeHTML(images)}</textarea>
      </label>
      <div class="product-preview" data-preview="${i}">
        ${preview}
      </div>
    </div>
  `;
}

function productPreview(p){
  const img = (p.images && p.images[0]) || 'https://via.placeholder.com/400x300?text=Фото';
  const price = p.price ? `${p.price} ${p.currency || '₽'}` : '—';
  return `
    <div class="card card-mini">
      <img src="${escapeHTML(img)}" alt="">
      <div>
        <h4>${escapeHTML(p.title || 'Название')}</h4>
        ${p.tag ? `<div class="badge">${escapeHTML(p.tag)}</div>` : ''}
        <p class="muted" style="margin:6px 0">${escapeHTML(p.summary || p.description || '')}</p>
        <div class="price">${escapeHTML(price)}</div>
      </div>
    </div>
  `;
}

function syncJSON(){
  const data = {
    socials: state.socials.map(s=>({
      label: s.label || '',
      url: s.url || '',
      icon: s.icon || ''
    })),
    products: state.products.map(p=>{
      const summary = p.summary || '';
      const prod = {
        title: p.title || '',
        slug: (p.slug || slugify(p.title || '')) || '',
        currency: p.currency || '₽',
        tag: p.tag || '',
        category: p.category || '',
        stock: p.stock || '',
        available: p.available !== false,
        short: summary,
        desc: summary,
        description: p.description || '',
        avitoUrl: p.avitoUrl || '',
        images: (p.images || []).filter(Boolean)
      };
      const price = toNumber(p.price);
      if(price !== undefined) prod.price = price;
      const oldPrice = toNumber(p.oldPrice);
      if(oldPrice !== undefined) prod.oldPrice = oldPrice;
      if(!prod.images.length) delete prod.images;
      if(!prod.avitoUrl) delete prod.avitoUrl;
      if(!summary) { delete prod.short; delete prod.desc; }
      if(!prod.description) delete prod.description;
      if(!prod.tag) delete prod.tag;
      if(!prod.category) delete prod.category;
      if(!prod.stock) delete prod.stock;
      if(!prod.currency) delete prod.currency;
      return prod;
    })
  };
  jsonArea.value = JSON.stringify(data, null, 2);
}

function toNumber(val){
  if(val === '' || val === null || val === undefined) return undefined;
  const n = Number(String(val).replace(',','.'));
  return Number.isFinite(n) ? n : undefined;
}

function updateProductPreview(index){
  const node = productsList.querySelector(`[data-preview="${index}"]`);
  if(node){
    node.innerHTML = productPreview(state.products[index]);
  }
  const slugNode = productsList.querySelector(`[data-slug-label="${index}"]`);
  if(slugNode){
    const slug = state.products[index].slug || slugify(state.products[index].title);
    slugNode.textContent = 'slug: ' + (slug || '—');
  }
}

addSocialBtn.addEventListener('click', ()=>{
  state.socials.push(normalizeSocial());
  renderSocials();
  syncJSON();
});

addProductBtn.addEventListener('click', ()=>{
  state.products.push(normalizeProduct());
  renderProducts();
  syncJSON();
});

socialList.addEventListener('input', e=>{
  const field = e.target.dataset.socField;
  if(!field) return;
  const index = Number(e.target.dataset.index);
  state.socials[index][field] = e.target.value;
  syncJSON();
});

socialList.addEventListener('click', e=>{
  const remove = e.target.dataset.removeSocial;
  if(remove !== undefined){
    state.socials.splice(Number(remove), 1);
    renderSocials();
    syncJSON();
  }
});

productsList.addEventListener('input', e=>{
  const field = e.target.dataset.productField;
  if(!field) return;
  const index = Number(e.target.dataset.index);
  if(field === 'images'){
    state.products[index].images = e.target.value.split('\n').map(s=>s.trim()).filter(Boolean);
  }else if(field === 'available'){
    state.products[index].available = e.target.checked;
  }else{
    state.products[index][field] = e.target.value;
  }
  updateProductPreview(index);
  syncJSON();
});

productsList.addEventListener('change', e=>{
  if(e.target.dataset.productField === 'available'){
    const index = Number(e.target.dataset.index);
    state.products[index].available = e.target.checked;
    updateProductPreview(index);
    syncJSON();
  }
});

productsList.addEventListener('click', e=>{
  if(e.target.dataset.removeProduct !== undefined){
    const idx = Number(e.target.dataset.removeProduct);
    if(confirm('Удалить товар?')){
      state.products.splice(idx,1);
      renderProducts();
      syncJSON();
    }
    return;
  }
  if(e.target.dataset.duplicateProduct !== undefined){
    const idx = Number(e.target.dataset.duplicateProduct);
    const clone = JSON.parse(JSON.stringify(state.products[idx]));
    clone.title = clone.title + ' (копия)';
    state.products.splice(idx+1,0,clone);
    renderProducts();
    syncJSON();
  }
});
</script>
</body>
</html>
